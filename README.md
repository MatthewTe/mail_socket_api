# SMTP/IMAP mail "socket" API
This is the repository for the mail socket api. It wraps logic around the SMTP and IMAP Client objects that allows a web server (primarily gmail) to serve as a means of data transfer for small, easily base64 encoded data. The purpose of this package is to allow data transfer from a device running special modelling software onto another deice that performs the web hosting services for the data pipeline output.

This package was written as part of the [CDL dfs datapipeline project](https://github.com/users/MatthewTe/projects/2).

## Table of Contents
* #### [Use of Mail "Socket" API](https://github.com/MatthewTe/mail_socket_api#use-of-mail-socket-api-1)
* #### [Documentation](https://github.com/MatthewTe/mail_socket_api#documentation-1)
  * ##### [smtp_socket](https://github.com/MatthewTe/mail_socket_api#smtp_socketself-smtp_server-port-mail_address-psswrd-debugtrue)
  * ##### [imap_socket](https://github.com/MatthewTe/mail_socket_api#imap_socketself-imap_server-mail_address-psswrd-debugtrue)

## Use of Mail "Socket" API
As described above the purpose of these mail 'sockets' are to wrap logic around the SMTP and IMAP Client objects that allows a web server to serve as a means of data transfer for small, easily accessible base64 encoded data. The function that this api serves in the data pipeline is highlighted by the diagram below:
![IMAGE NOT FOUND](https://github.com/MatthewTe/mail_socket_api/blob/master/resources/Mail%20Socket%20API.png)

## Documentation
The two main socket objects for the package are contained in the `mail_transfer_api.py`. The two 'socket' objects are:
`smtp_socket` and `imap_socket`.

### `smtp_socket(self, smtp_server, port, mail_address, psswrd, debug=True)`
This is the socket object that is used to send emails with data as attachments. The object inherits from the native python smtp object `smtplib.SMTP`. It is initialized by the main methods that are used to initialize a `SMTP` object:

- `smtp_server` : The name of the smtp mail server. The socket can theoretically be used with any SMTP server but it is intended to make use of the `smtp.gmail.com` STMP server. If using another SMTP server errors and conflicts may occur.
- `port` : Usually port 587, can be different port if errors arises.
- `mail_address` : The actual email address used to send the message.
- `psswrd` : The password to the mail address account.
- `debug` The boolean that determines if the socket object prints debug statements during its operations.

When this socket is initialized it makes uses of its parent `SMTP` object to establish a connection with the SMTP server and login. This initialization facilitates the use of other methods that upload data to the SMTP server.

#### `send_forecast_data(self, data_path, client_name)`
This is the method that allows a csv file containing seven day forecast data generated by the HD model to be uploaded to the mail server. It is relatively straight forward in its approach to sending data. It converts the csv file into a base64 encoded data payload and then send an email with an empty body and the file as an attachemnt to the SMTP server.

The `client_name` parameter is used to build the email Subject string that is parsed on the other end by the `IMAP` data query api. The subject of the email is built as follows: `{client_name};{file_name};forecast;{datetime_sent}`. This Subject string is unpacked and is utilized by the `IMAP` socket for processing data. The `client_name` must be the same name that is being used to query the email messages in the IMAP socket.


### `imap_socket(self, imap_server, mail_address, psswrd, debug=True)`
This is the sister socket to the `smtp_socket` object. It mirrors the `smtp_socket's` data sending methods that allows data to be read from the mail server.

The socket object is initialized via the use of its parent method `imapclient.IMAPClient` and the Parameters required to initialize said object:

- `imap_server` : The name of the imap mail server. The socket can theoretically be used with any IMAP server but it is intended to make use of the `imap.gmail.com` IMAP server. If using another IMAP server errors and conflicts may occur.
- `mail_address` : The actual email address used to send the message.
- `psswrd` : The password to the mail address account.
- `debug` The boolean that determines if the socket object prints debug statements during its operations.

#### `get_forecast_data(self, client_name)`
This is the sister method to the `smtp_socket.send_forecast_data()`. It accesses the IMAP mail server indicated by the method and parses all email data returned searching for the most recent forecast email sent with the client name parameter `client_name`. The method returns a pandas dataframe containing the forecasting data retrieved from the email.

The `get_forecast_data()` method extracts the csv data attached to the relevant email as a base64 encoded data binary. This binary is decoded into a formatted string and then converted and formatted into the dataframe. The logic of extracting seven day forecast data is as follows:

The `header` component of the email (that is built and sent by the `smtp_socket.send_forecast_data()`) is key in parsing emails. The header component (The Email Subject) is the first element of email to be parsed and is always in the format: `"{client_name};{file_name};forecast;{datetime_sent}"`. The `get_forecast_data()` method parses this string and ensures that only the attachments from the email with matching `client_name` Parameters and most recent `datetime_sent` will be extracted.

```python
imap_socket.get_forecast_data():

# Selecting the INBOX folder for the email server:
self.select_folder('INBOX')

# Extracting a list of email UID vals for client specific email:
uid_lst = self.search(['SUBJECT', f''{client_name}])

# Extracting the email messages w/ uid list:
messages_dict = self.fetch(uid_lst, data=['BODY[]', 'FLAGS'])

# Iterating through {messages} contents to select relevant information:
for uid_key in messages_dict:

  # Declaring email as a pyzmail object to extract header:
  header = pyzmail.PyzMessage.factory(messages[uid][b'BODY[]']).get_subject().split(';')

  # Parsing header to find the most recent client email sent:
  if header[0] == client_name:

    date_val = datetime.datetime.strptime(header_lst[-1], '%d/%m/%Y %H:%M')

    # Adding datetime to the dict as key/value {uid: datetime}:
    header_datetime_dict[date_val] = uid

    # Adding datetime object to the list:
    datetime_lst.append(date_val)

# Extracting the most recent client email UID:
most_recent = max(datetime_lst)

# Extracting the corresponding uid for the most recent client email:
recent_uid = header_datetime_dict[most_recent]


# Declaring most recent email as pyzmail object:
pyz_msg = pyzmail.PyzMessage.factory(messages[recent_uid][b'BODY[]'])

# Extracting and decoding base64 data binary:
for mailpart in pyz_msg.mailparts:

  csv_string = (pyzmail.decode_text(mailpart.get_payload(),
              mailpart.charset, None)[0])

  # Converting csv string to pandas dataframe:
  # Converting csv string to a pandas dataframe through StringIO:
  csv_string_data = StringIO(csv_string)

  # Converting formatted string to dataframe:
  payload_df = pd.read_table(csv_string_data, sep=',')

return payload_df
```    

#### `clear_forecast_data(self, client_name)`
When called this method PERMANENTLY DELETES ALL of the current emails on the mail server with the client name that matches the input parameter `client_name` EXCEPT for the MOST RECENTLY SENT email. I.E: After this method runs there is one email left on the server with the corresponding `client_name`, and it is the most recently sent client_name email.

This is a method for long term maintenance of the IMAP server. It parses all current message headers in the email server for the UIDs of messages associated with the input parameter `client_name`.

These messages are sorted by the datetime values associated with the mail header and a list is built of all the UID values of every datetime object EXCEPT the most recent datetime value. This list of UIDs are then used to permanently delete emails from the email server via the use of the `imap_socket's` parent object's (`IMAPClient`) methods:
`.IMAPClient.delete_messages()` and `IMAPClient.expunge()`.
